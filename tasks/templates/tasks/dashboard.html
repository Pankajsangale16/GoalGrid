{% extends 'tasks/base.html' %}
{% load static %}

{% block title %}Client-Centric Task Dashboard{% endblock %}

{% block content %}
<!-- Hidden CSRF token for AJAX requests -->
{% csrf_token %}

<!-- Global Dashboard Header -->
<div class="global-dashboard-header">
    <div class="global-dashboard-content">
        <h2 class="global-title">Global Dashboard</h2>
        <div class="global-progress-bars">
            <div class="global-progress-card">
                <div class="circular-progress-global" data-percentage="{{ global_completion }}" data-color="neon-green">
                    <svg class="progress-ring-global" width="160" height="160">
                        <circle class="progress-ring-circle-bg" cx="80" cy="80" r="70"></circle>
                        <circle class="progress-ring-circle" cx="80" cy="80" r="70" data-percentage="{{ global_completion }}"></circle>
                    </svg>
                    <div class="progress-text-global">
                        <span class="progress-value-global" id="global-completion-value">{{ global_completion }}</span>
                        <span class="progress-label-global">%</span>
                    </div>
                </div>
                <p class="progress-title-global">Completed</p>
                <p class="progress-count-global">{{ completed_tasks }} of {{ total_tasks }} tasks</p>
            </div>
            
            <div class="global-progress-card">
                <div class="circular-progress-global" data-percentage="{{ global_remaining }}" data-color="vivid-orange">
                    <svg class="progress-ring-global" width="160" height="160">
                        <circle class="progress-ring-circle-bg" cx="80" cy="80" r="70"></circle>
                        <circle class="progress-ring-circle" cx="80" cy="80" r="70" data-percentage="{{ global_remaining }}"></circle>
                    </svg>
                    <div class="progress-text-global">
                        <span class="progress-value-global" id="global-remaining-value">{{ global_remaining }}</span>
                        <span class="progress-label-global">%</span>
                    </div>
                </div>
                <p class="progress-title-global">Remaining</p>
                <p class="progress-count-global">{{ pending_tasks }} of {{ total_tasks }} tasks</p>
            </div>
        </div>
        <div class="global-stats">
            <div class="stat-item">
                <span class="stat-value">{{ total_clients }}</span>
                <span class="stat-label">Clients</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">{{ total_tasks }}</span>
                <span class="stat-label">Total Tasks</span>
            </div>
        </div>
    </div>
</div>

<!-- Search and Add Client Section -->
<div class="search-add-section">
    <!-- Search Bar -->
    <div class="search-container">
        <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input type="text" 
               id="client-search-input" 
               class="search-input" 
               placeholder="Search clients..." 
               autocomplete="off"
               oninput="filterClients(this.value)">
        <button class="search-clear" id="search-clear-btn" onclick="clearSearch()" style="display: none;" type="button">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
    </div>
    
    <!-- Add New Client -->
    <div class="add-client-section">
        <button class="btn-new-client" onclick="showClientForm()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            New Client
        </button>
        <div id="client-form" class="client-form" style="display: none;">
            <input type="text" id="client-name-input" placeholder="Enter client name" class="client-input" autocomplete="off">
            <button onclick="createClient()" class="btn-submit" type="button">Add</button>
            <button onclick="hideClientForm()" class="btn-cancel" type="button">Cancel</button>
        </div>
    </div>
</div>

<!-- Clients List -->
<div class="clients-list-container" id="clients-grid">
    {% for client in clients %}
    <div class="client-list-item" data-client-id="{{ client.id }}" data-client-name="{{ client.name|lower }}">
        <!-- Client List Header (Clickable) -->
        <div class="client-list-header" onclick="toggleClient({{ client.id }})">
            <div class="client-list-info">
                <svg class="expand-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
                <h3 class="client-name-list">{{ client.name }}</h3>
                <span class="client-task-count">({{ client.total_tasks }} tasks)</span>
            </div>
            <div class="client-list-actions" onclick="event.stopPropagation()">
                <button class="btn-delete-client-small" onclick="deleteClient({{ client.id }}, '{{ client.name }}')" title="Delete Client">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Client Details (Collapsible) -->
        <div class="client-details" id="client-details-{{ client.id }}" style="display: none;">
            <!-- Client Progress Bars -->
            <div class="client-progress-section">
                <div class="client-progress-card">
                    <div class="circular-progress-client" data-percentage="{{ client.completion_percentage }}" data-color="neon-green" data-client-id="{{ client.id }}">
                        <svg class="progress-ring-client" width="100" height="100">
                            <circle class="progress-ring-circle-bg" cx="50" cy="50" r="44"></circle>
                            <circle class="progress-ring-circle" cx="50" cy="50" r="44" data-percentage="{{ client.completion_percentage }}"></circle>
                        </svg>
                        <div class="progress-text-client">
                            <span class="progress-value-client" id="client-{{ client.id }}-completion">{{ client.completion_percentage }}</span>
                            <span class="progress-label-client">%</span>
                        </div>
                    </div>
                    <p class="progress-title-client">Progress</p>
                </div>
                
                <div class="client-progress-card">
                    <div class="circular-progress-client" data-percentage="{{ client.remaining_percentage }}" data-color="vivid-orange" data-client-id="{{ client.id }}">
                        <svg class="progress-ring-client" width="100" height="100">
                            <circle class="progress-ring-circle-bg" cx="50" cy="50" r="44"></circle>
                            <circle class="progress-ring-circle" cx="50" cy="50" r="44" data-percentage="{{ client.remaining_percentage }}"></circle>
                        </svg>
                        <div class="progress-text-client">
                            <span class="progress-value-client" id="client-{{ client.id }}-remaining">{{ client.remaining_percentage }}</span>
                            <span class="progress-label-client">%</span>
                        </div>
                    </div>
                    <p class="progress-title-client">Remaining</p>
                </div>
            </div>
            
            <!-- Tasks List -->
            <div class="client-tasks">
                <div class="task-list-header">
                    <h4>Tasks ({{ client.total_tasks }})</h4>
                </div>
                <div class="tasks-list" id="tasks-{{ client.id }}">
                    {% for task in client.tasks.all %}
                    <div class="task-item" data-task-id="{{ task.id }}">
                        <input type="checkbox" 
                               class="task-checkbox" 
                               data-task-id="{{ task.id }}"
                               {% if task.is_completed %}checked{% endif %}
                               onchange="toggleTask({{ task.id }})">
                        <span class="custom-checkbox">
                            <span class="checkbox-icon">{% if task.is_completed %}☑{% else %}□{% endif %}</span>
                        </span>
                        <span class="task-title {% if task.is_completed %}completed{% endif %}">{{ task.title }}</span>
                        <button class="btn-delete-task" onclick="deleteTask({{ task.id }})" title="Delete Task">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                    {% empty %}
                    <p class="no-tasks">No tasks yet. Add one below!</p>
                    {% endfor %}
                </div>
                
                <!-- Add Task Input -->
                <div class="add-task-section">
                    <input type="text" 
                           id="task-input-{{ client.id }}" 
                           placeholder="Enter task title..." 
                           class="task-input"
                           autocomplete="off"
                           onkeypress="if(event.key === 'Enter') createTask({{ client.id }})"
                           onkeydown="if(event.key === 'Enter') event.preventDefault()">
                    <button onclick="createTask({{ client.id }})" class="btn-add-task-small" type="button">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="empty-state">
        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" opacity="0.3">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
        </svg>
        <h3>No clients yet</h3>
        <p>Create your first client to get started!</p>
    </div>
    {% endfor %}
</div>

<!-- No Results Message -->
<div id="no-results" class="no-results" style="display: none;">
    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" opacity="0.3">
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.35-4.35"></path>
    </svg>
    <h3>No clients found</h3>
    <p>Try a different search term</p>
</div>

<script>
// Get CSRF token
function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken');
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Client Management
function showClientForm() {
    document.getElementById('client-form').style.display = 'flex';
    document.getElementById('client-name-input').focus();
}

function hideClientForm() {
    document.getElementById('client-form').style.display = 'none';
    document.getElementById('client-name-input').value = '';
}

function createClient() {
    const name = document.getElementById('client-name-input').value.trim();
    if (!name) {
        alert('Please enter a client name');
        return;
    }
    
    const formData = new FormData();
    formData.append('name', name);
    formData.append('csrfmiddlewaretoken', getCSRFToken());
    
    fetch('/client/create/', {
        method: 'POST',
        body: formData,
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // Reload to show new client
        } else {
            alert(data.error || 'Error creating client');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating client');
    });
}

function deleteClient(clientId, clientName) {
    if (!confirm(`Are you sure you want to delete "${clientName}" and all its tasks?`)) {
        return;
    }
    
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', getCSRFToken());
    
    fetch(`/client/delete/${clientId}/`, {
        method: 'POST',
        body: formData,
    })
    .then(() => {
        location.reload();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting client');
    });
}

// Task Management
function createTask(clientId) {
    const input = document.getElementById(`task-input-${clientId}`);
    const title = input.value.trim();
    
    if (!title) {
        alert('Please enter a task title');
        return;
    }
    
    const formData = new FormData();
    formData.append('title', title);
    formData.append('csrfmiddlewaretoken', getCSRFToken());
    
    fetch(`/client/${clientId}/task/create/`, {
        method: 'POST',
        body: formData,
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            input.value = '';
            location.reload(); // Reload to show new task
        } else {
            alert(data.error || 'Error creating task');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating task');
    });
}

function toggleTask(taskId) {
    const checkbox = document.querySelector(`input[data-task-id="${taskId}"]`);
    const taskItem = document.querySelector(`.task-item[data-task-id="${taskId}"]`);
    const checkboxIcon = taskItem.querySelector('.checkbox-icon');
    const taskTitle = taskItem.querySelector('.task-title');
    
    checkbox.disabled = true;
    
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', getCSRFToken());
    
    fetch(`/task/toggle/${taskId}/`, {
        method: 'POST',
        body: formData,
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update checkbox icon
            checkboxIcon.textContent = data.is_completed ? '☑' : '□';
            
            // Toggle completed class
            if (data.is_completed) {
                taskTitle.classList.add('completed');
            } else {
                taskTitle.classList.remove('completed');
            }
            
            // Update client progress bars
            const clientId = data.client.id;
            animateValue(`client-${clientId}-completion`, 
                parseInt(document.getElementById(`client-${clientId}-completion`).textContent), 
                data.client.completion_percentage);
            animateValue(`client-${clientId}-remaining`, 
                parseInt(document.getElementById(`client-${clientId}-remaining`).textContent), 
                data.client.remaining_percentage);
            
            // Update client progress bars visually
            updateProgressBar(`.circular-progress-client[data-client-id="${clientId}"][data-color="neon-green"]`, data.client.completion_percentage);
            updateProgressBar(`.circular-progress-client[data-client-id="${clientId}"][data-color="vivid-orange"]`, data.client.remaining_percentage);
            
            // Update global progress
            animateValue('global-completion-value', 
                parseInt(document.getElementById('global-completion-value').textContent), 
                data.global.completion_percentage);
            animateValue('global-remaining-value', 
                parseInt(document.getElementById('global-remaining-value').textContent), 
                data.global.remaining_percentage);
            
            updateProgressBar('.circular-progress-global[data-color="neon-green"]', data.global.completion_percentage);
            updateProgressBar('.circular-progress-global[data-color="vivid-orange"]', data.global.remaining_percentage);
        }
        checkbox.disabled = false;
    })
    .catch(error => {
        console.error('Error:', error);
        checkbox.checked = !checkbox.checked;
        checkbox.disabled = false;
    });
}

function deleteTask(taskId) {
    if (!confirm('Are you sure you want to delete this task?')) {
        return;
    }
    
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', getCSRFToken());
    
    fetch(`/task/delete/${taskId}/`, {
        method: 'POST',
        body: formData,
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error deleting task');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting task');
    });
}

// Animation functions
function animateValue(id, start, end, duration = 500) {
    const element = document.getElementById(id);
    if (!element) return;
    
    const startTime = performance.now();
    
    function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const easeOutCubic = 1 - Math.pow(1 - progress, 3);
        const current = Math.round(start + (end - start) * easeOutCubic);
        element.textContent = current;
        
        if (progress < 1) {
            requestAnimationFrame(update);
        } else {
            element.textContent = end;
        }
    }
    
    requestAnimationFrame(update);
}

function updateProgressBar(selector, percentage) {
    const progressBar = document.querySelector(selector);
    if (!progressBar) return;
    
    const circle = progressBar.querySelector('.progress-ring-circle');
    if (!circle) return;
    
    const radius = circle.r.baseVal.value;
    const circumference = radius * 2 * Math.PI;
    const offset = circumference - (percentage / 100) * circumference;
    
    circle.style.transition = 'stroke-dashoffset 0.8s cubic-bezier(0.4, 0, 0.2, 1)';
    circle.style.strokeDashoffset = offset;
}

// Search Functionality
function filterClients(searchTerm) {
    const searchValue = searchTerm.toLowerCase().trim();
    const clientItems = document.querySelectorAll('.client-list-item');
    const clientCards = document.querySelectorAll('.client-card'); // Legacy support
    const noResults = document.getElementById('no-results');
    const clearBtn = document.getElementById('search-clear-btn');
    let visibleCount = 0;
    
    // Filter client list items (new format)
    clientItems.forEach(item => {
        const clientName = item.getAttribute('data-client-name') || '';
        
        if (clientName.includes(searchValue)) {
            item.style.display = 'block';
            visibleCount++;
        } else {
            item.style.display = 'none';
        }
    });
    
    // Filter client cards (legacy format)
    clientCards.forEach(card => {
        const clientName = card.getAttribute('data-client-name') || '';
        
        if (clientName.includes(searchValue)) {
            card.style.display = 'block';
            if (visibleCount === 0) visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });
    
    // Show/hide clear button
    if (searchValue.length > 0) {
        clearBtn.style.display = 'flex';
    } else {
        clearBtn.style.display = 'none';
    }
    
    // Show/hide no results message
    if (visibleCount === 0 && searchValue.length > 0) {
        noResults.style.display = 'block';
    } else {
        noResults.style.display = 'none';
    }
}

function clearSearch() {
    const searchInput = document.getElementById('client-search-input');
    searchInput.value = '';
    filterClients('');
    searchInput.focus();
}

// Toggle Client Details
function toggleClient(clientId) {
    const details = document.getElementById(`client-details-${clientId}`);
    const header = document.querySelector(`.client-list-item[data-client-id="${clientId}"] .client-list-header`);
    const expandIcon = header.querySelector('.expand-icon');
    
    if (details.style.display === 'none' || !details.style.display) {
        // Expand
        details.style.display = 'block';
        expandIcon.style.transform = 'rotate(180deg)';
        header.classList.add('expanded');
        
        // Initialize progress bars if not already done
        setTimeout(() => {
            initializeProgressBars();
        }, 100);
    } else {
        // Collapse
        details.style.display = 'none';
        expandIcon.style.transform = 'rotate(0deg)';
        header.classList.remove('expanded');
    }
}
</script>
{% endblock %}

